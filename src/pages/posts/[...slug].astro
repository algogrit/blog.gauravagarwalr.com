---
import { Image } from 'astro:assets';
import { type CollectionEntry, getCollection, render } from 'astro:content';
import FormattedDate from '../../components/FormattedDate';
import Base from '../../layouts/Base.astro';
import PostTagPill from '../../components/tags/PostTagPill';
// import PostNewsletter from '../../components/cta/PostNewsletter';
import RelatedPosts from '../../components/posts/RelatedPosts';
import Comments from '../../components/sections/Comments';

export async function getStaticPaths() {
	const posts = await getCollection('posts');
	return posts.map((post) => ({
		params: { slug: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<'posts'>;

const post = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(post);

const requiredTags = post.data.tags;
const currentPostID = post.id;

const relatedPosts = (await getCollection('posts'))
	.filter(post => post.id != currentPostID)
	.filter(post =>
		requiredTags.some(tag => post.data.tags.includes(tag))
	).splice(0, 2);

---

<Base>
	<article class="max-w-4xl mx-auto px-4 py-12">
		<header class="mb-8">
			<div class="flex flex-wrap gap-2 mb-4 max-w-2xl">
				{post.data.tags.map((tag) => (
					<PostTagPill tag={tag} />
				))}
			</div>
			<h1 class="text-4xl md:text-5xl font-bold mb-4">{post.data.title}</h1>
			<div class="flex items-center gap-4 text-gray-600 dark:text-gray-400">
				<span class="inline-flex items-center gap-1">
					<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
					</svg>
					<FormattedDate date={post.data.date} />
				</span>
				<span>â€¢</span>
				<span>{remarkPluginFrontmatter.minutesRead}</span>
			</div>
		</header>

		<div class="hero-image">
			{post.data.heroImage && <Image width={1020} height={510} src={post.data.heroImage} alt="" />}
		</div>
		<div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300">
			<Content />
		</div>

		<!-- <PostNewsletter/> -->
		<RelatedPosts posts={relatedPosts}/>
		<Comments client:only/>
	</article>
</Base>
